@using Kuestencode.Shared.Contracts.Navigation
@using MudBlazor
@inject NavigationManager NavigationManager

@if (Item.Type == NavItemType.Divider)
{
    <MudDivider Class="my-2" />
}
else if (Item.Type == NavItemType.Group)
{
    @if (HasIconName(Item.Icon))
    {
        <MudNavGroup Title="@Item.Label" Icon="@GetIcon(Item.Icon)" Expanded="@IsExpanded(Item)">
            @foreach (var child in Item.Children)
            {
                <NavItemRenderer Item="child" CurrentUri="CurrentUri" />
            }
        </MudNavGroup>
    }
    else
    {
        <MudNavGroup Title="@Item.Label" Class="nav-group--no-icon" Expanded="@IsExpanded(Item)">
            @foreach (var child in Item.Children)
            {
                <NavItemRenderer Item="child" CurrentUri="CurrentUri" />
            }
        </MudNavGroup>
    }
}
else
{
    if (IsIconUrl(Item.Icon))
    {
        <MudNavLink Href="@Item.Href">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudImage Src="@Item.Icon" Alt="@Item.Label" Width="50" Height="50" />
                <span class="@(IsOverviewItem(Item) ? "nav-overview-link" : "")">@Item.Label</span>
            </MudStack>
        </MudNavLink>
    }
    else
    {
        <MudNavLink Href="@Item.Href">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                @if (HasIconName(Item.Icon))
                {
                    <MudIcon Icon="@GetIcon(Item.Icon)" />
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Circle" Style="visibility:hidden;" />
                }
                <span class="@(IsOverviewItem(Item) ? "nav-overview-link" : "")">@Item.Label</span>
            </MudStack>
        </MudNavLink>
    }
}

@code {
    [Parameter]
    public NavItemDto Item { get; set; } = default!;

    [Parameter]
    public string? CurrentUri { get; set; }

    private string GetIcon(string? iconName)
    {
        if (IsIconUrl(iconName))
        {
            return Icons.Material.Filled.Circle;
        }

        return iconName switch
        {
            "Dashboard" => Icons.Material.Filled.Dashboard,
            "Receipt" => Icons.Material.Filled.Receipt,
            "Settings" => Icons.Material.Filled.Settings,
            "Palette" => Icons.Material.Filled.Palette,
            "PictureAsPdf" => Icons.Material.Filled.PictureAsPdf,
            "Email" => Icons.Material.Filled.Email,
            "People" => Icons.Material.Filled.People,
            "Business" => Icons.Material.Filled.Business,
            "Storage" => Icons.Material.Filled.Storage,
            "AccessTime" => Icons.Material.Filled.AccessTime,
            "Schedule" => Icons.Material.Filled.Schedule,
            "WatchLater" => Icons.Material.Filled.WatchLater,
            "Timelapse" => Icons.Material.Filled.Timelapse,
            "Edit" => Icons.Material.Filled.Edit,
            _ => Icons.Material.Filled.Circle
        };
    }

    private static bool IsIconUrl(string? iconName)
    {
        if (string.IsNullOrWhiteSpace(iconName))
        {
            return false;
        }

        return iconName.StartsWith("/") || iconName.StartsWith("http", StringComparison.OrdinalIgnoreCase);
    }

    private static bool HasIconName(string? iconName)
    {
        return !string.IsNullOrWhiteSpace(iconName) && !IsIconUrl(iconName);
    }

    private static bool IsOverviewItem(NavItemDto item)
    {
        return string.Equals(item.Label, "Übersicht", StringComparison.OrdinalIgnoreCase)
            && string.Equals(item.Href, "/", StringComparison.OrdinalIgnoreCase);
    }

    private bool IsExpanded(NavItemDto item)
    {
        if (item.Type != NavItemType.Group || item.Children.Count == 0)
        {
            return false;
        }

        var currentUri = CurrentUri ?? NavigationManager.Uri;
        if (string.IsNullOrWhiteSpace(currentUri))
        {
            return false;
        }

        return item.Children.Any(child => IsMatch(currentUri, child.Href));
    }

    private static bool IsMatch(string currentUri, string href)
    {
        if (string.IsNullOrWhiteSpace(href))
        {
            return false;
        }

        return currentUri.Contains(href, StringComparison.OrdinalIgnoreCase);
    }
}
