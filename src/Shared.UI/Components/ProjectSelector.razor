@using Kuestencode.Core.Interfaces

@if (IsAvailable && Projects.Count > 0)
{
    <MudStack Spacing="1">
        <MudSelect T="int?" Label="Projekt" Variant="Variant.Outlined" Clearable="true"
                   Value="SelectedProjectId" ValueChanged="OnSelectedProjectChanged">
            <MudSelectItem T="int?" Value="@(null)">Kein Projekt</MudSelectItem>
            @foreach (var project in Projects)
            {
                <MudSelectItem T="int?" Value="project.Id">@FormatProject(project)</MudSelectItem>
            }
        </MudSelect>

        @if (SelectedProjectId.HasValue)
        {
            var selectedProject = Projects.FirstOrDefault(p => p.Id == SelectedProjectId.Value);
            if (selectedProject != null)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                    Kunde: @selectedProject.CustomerName (wird automatisch zugeordnet)
                </MudText>
            }
        }
    </MudStack>
}

@code {
    [Parameter]
    public List<IProject> Projects { get; set; } = new();

    [Parameter]
    public bool IsAvailable { get; set; } = true;

    [Parameter]
    public int? SelectedProjectId { get; set; }

    [Parameter]
    public EventCallback<int?> SelectedProjectIdChanged { get; set; }

    [Parameter]
    public string? UnavailableHref { get; set; } = "/settings/modules";

    private async Task OnSelectedProjectChanged(int? value)
    {
        SelectedProjectId = value;
        await SelectedProjectIdChanged.InvokeAsync(value);
    }

    private string FormatProject(IProject project)
    {
        var label = $"{project.Name} - {project.CustomerName}";
        if (!string.IsNullOrWhiteSpace(project.ProjectNumber))
        {
            label += $" ({project.ProjectNumber})";
        }

        return label;
    }
}
