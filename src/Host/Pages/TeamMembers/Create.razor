@page "/team-members/create"
@using Kuestencode.Werkbank.Host.Models
@inject Kuestencode.Werkbank.Host.Services.ITeamMemberService TeamMemberService
@inject Kuestencode.Werkbank.Host.Services.IInviteService InviteService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Neuer Mitarbeiter - Kuestencode Werkbank</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h4" GutterBottom="true">Neuer Mitarbeiter</MudText>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="my-4">@_errorMessage</MudAlert>
        }

        <EditForm Model="@_member" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <MudGrid>
                <MudItem xs="12">
                    <MudTextField Label="Name" @bind-Value="_member.DisplayName"
                                 For="@(() => _member.DisplayName)" Required="true" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField Label="Email" @bind-Value="_member.Email"
                                 For="@(() => _member.Email)" InputType="InputType.Email" Required="true" />
                </MudItem>

                <MudItem xs="12">
                    <MudSelect T="UserRole" Label="Rolle" @bind-Value="_member.Role">
                        <MudSelectItem T="UserRole" Value="UserRole.Admin">Admin</MudSelectItem>
                        <MudSelectItem T="UserRole" Value="UserRole.Buero">Buero</MudSelectItem>
                        <MudSelectItem T="UserRole" Value="UserRole.Mitarbeiter">Mitarbeiter</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    <MudCheckBox @bind-Value="_member.IsActive" Label="Aktiv" />
                </MudItem>

                <MudItem xs="12">
                    <MudCheckBox @bind-Value="_sendInvite" Label="Einladung direkt senden" />
                    @if (_sendInvite)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Info" Class="mt-1">
                            Benutzer erhaelt eine E-Mail mit Einladungslink.
                        </MudText>
                    }
                </MudItem>

                <MudItem xs="12" Class="d-flex justify-end gap-2">
                    <MudButton Variant="Variant.Filled" Color="Color.Default"
                              OnClick="Cancel">Abbrechen</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                              ButtonType="ButtonType.Submit" Disabled="@_saving">
                        @if (_saving)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Speichert...</MudText>
                        }
                        else
                        {
                            <MudText>Speichern</MudText>
                        }
                    </MudButton>
                </MudItem>
            </MudGrid>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    private TeamMember _member = new TeamMember();
    private bool _saving;
    private bool _sendInvite = true;
    private string? _errorMessage;

    private async Task HandleSubmit()
    {
        _saving = true;
        _errorMessage = null;

        try
        {
            var created = await TeamMemberService.CreateAsync(_member);

            if (_sendInvite && !string.IsNullOrWhiteSpace(created.Email))
            {
                try
                {
                    await InviteService.CreateInviteAsync(created.Id);
                    Snackbar.Add("Mitarbeiter erstellt und Einladung gesendet.", Severity.Success);
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Mitarbeiter erstellt, aber Einladung fehlgeschlagen: {ex.Message}", Severity.Warning);
                }
            }
            else
            {
                Snackbar.Add("Mitarbeiter wurde erstellt.", Severity.Success);
            }

            NavigationManager.NavigateTo("/team-members");
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/team-members");
    }
}
