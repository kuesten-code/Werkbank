@page "/team-members/edit/{Id:guid}"
@using Kuestencode.Werkbank.Host.Models
@inject Kuestencode.Werkbank.Host.Services.ITeamMemberService TeamMemberService
@inject Kuestencode.Werkbank.Host.Services.IInviteService InviteService
@inject Kuestencode.Werkbank.Host.Services.IMobileTokenService MobileTokenService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject Kuestencode.Werkbank.Host.Services.IWerkbankSettingsService WerkbankSettingsService

<PageTitle>Mitarbeiter bearbeiten - Küstencode Werkbank</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h4" GutterBottom="true">Mitarbeiter bearbeiten</MudText>

        @if (_loading)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        }
        else if (_member == null)
        {
            <MudAlert Severity="Severity.Error">Mitarbeiter nicht gefunden.</MudAlert>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4"
                      OnClick="Cancel">
                Zurück zur Liste
            </MudButton>
        }
        else
        {
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="my-4">@_errorMessage</MudAlert>
            }

            <EditForm Model="@_member" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <MudGrid>
                    <MudItem xs="12">
                        <MudTextField Label="Name" @bind-Value="_member.DisplayName"
                                     For="@(() => _member.DisplayName)" Required="true" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField Label="E-Mail" @bind-Value="_member.Email"
                                     For="@(() => _member.Email)" InputType="InputType.Email" Required="true" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudSelect T="UserRole" Label="Rolle" @bind-Value="_member.Role">
                            <MudSelectItem T="UserRole" Value="UserRole.Admin">Admin</MudSelectItem>
                            <MudSelectItem T="UserRole" Value="UserRole.Buero">Büro</MudSelectItem>
                            <MudSelectItem T="UserRole" Value="UserRole.Mitarbeiter">Mitarbeiter</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12">
                        <MudCheckBox @bind-Value="_member.IsActive" Label="Aktiv" />
                    </MudItem>

                    @if (_member.IsLockedByAdmin)
                    {
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Warning" Class="mb-2">
                                Dieser Account ist gesperrt.
                            </MudAlert>
                            <MudButton Variant="Variant.Outlined" Color="Color.Warning"
                                      StartIcon="@Icons.Material.Filled.LockOpen"
                                      OnClick="UnlockAccount">
                                Account entsperren
                            </MudButton>
                        </MudItem>
                    }

                    @if (!string.IsNullOrEmpty(_member.Email))
                    {
                        <MudItem xs="12">
                            <MudButton Variant="Variant.Outlined" Color="Color.Info"
                                      StartIcon="@Icons.Material.Filled.Send"
                                      OnClick="SendNewInvite" Disabled="@_sendingInvite">
                                @if (_sendingInvite)
                                {
                                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                    <MudText Class="ms-2">Sendet...</MudText>
                                }
                                else
                                {
                                    <MudText>Neuen Einladungslink senden</MudText>
                                }
                            </MudButton>
                            <MudText Typo="Typo.caption" Class="mt-1">
                                Setzt das bisherige Passwort zurück. Benutzer muss ein neues Passwort setzen.
                            </MudText>
                        </MudItem>
                    }

                    @* Mobiler Zugang (nur für Mitarbeiter) *@
                    @if (_member.Role == UserRole.Mitarbeiter)
                    {
                        <MudItem xs="12">
                            <MudDivider Class="my-4" />
                            <MudText Typo="Typo.h6" Class="mb-3">Mobiler Zugang</MudText>

                            @if (string.IsNullOrEmpty(_member.MobileToken))
                            {
                                <MudText Typo="Typo.body2" Class="mb-2">
                                    Kein mobiler Zugang eingerichtet. Ermöglicht die Zeiterfassung über das Handy mit PIN-Zugang.
                                </MudText>
                                <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                                          StartIcon="@Icons.Material.Filled.PhoneAndroid"
                                          OnClick="CreateMobileAccess">
                                    Mobilen Zugang erstellen
                                </MudButton>
                            }
                            else
                            {
                                <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-background-grey);">
                                    <MudStack Spacing="2">
                                        <div>
                                            <MudText Typo="Typo.body2" Class="mb-1"><strong>Zugangslink:</strong></MudText>
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <code style="flex: 1; padding: 0.5rem; background: white; border-radius: 4px;">
                                                    @_mobileUrl
                                                </code>
                                                <MudTooltip Text="Link kopieren">
                                                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                                                  Color="Color.Primary"
                                                                  OnClick="CopyMobileLink" />
                                                </MudTooltip>
                                            </MudStack>
                                        </div>

                                        <MudStack Row="true" Spacing="3">
                                            <MudChip T="string" Size="Size.Small" Color="@(_member.MobilePinSet ? Color.Success : Color.Default)">
                                                PIN: @(_member.MobilePinSet ? "Gesetzt" : "Nicht gesetzt")
                                            </MudChip>
                                            @if (_member.MobileTokenLocked)
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="Color.Error">
                                                    Gesperrt
                                                </MudChip>
                                            }
                                        </MudStack>

                                        <MudStack Row="true" Spacing="2" Class="mt-2">
                                            @if (_member.MobileTokenLocked)
                                            {
                                                <MudButton Variant="Variant.Text" Color="Color.Warning"
                                                          Size="Size.Small"
                                                          StartIcon="@Icons.Material.Filled.LockOpen"
                                                          OnClick="UnlockMobileAccess">
                                                    Entsperren
                                                </MudButton>
                                            }
                                            <MudButton Variant="Variant.Text" Color="Color.Secondary"
                                                      Size="Size.Small"
                                                      StartIcon="@Icons.Material.Filled.Refresh"
                                                      OnClick="ResetMobileAccess">
                                                Neuen Link generieren
                                            </MudButton>
                                        </MudStack>
                                    </MudStack>
                                </MudPaper>
                                <MudText Typo="Typo.caption" Class="mt-2">
                                    Der Mitarbeiter kann mit diesem Link über das Handy seine Arbeitszeiten erfassen.
                                </MudText>
                            }
                        </MudItem>
                    }

                    <MudItem xs="12" Class="d-flex justify-end gap-2">
                        <MudButton Variant="Variant.Filled" Color="Color.Default"
                                  OnClick="Cancel">Abbrechen</MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                  ButtonType="ButtonType.Submit" Disabled="@_saving">
                            @if (_saving)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Speichert...</MudText>
                            }
                            else
                            {
                                <MudText>Speichern</MudText>
                            }
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </EditForm>
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter] public Guid Id { get; set; }

    private bool _loading = true;
    private bool _saving;
    private bool _sendingInvite;
    private string? _errorMessage;
    private TeamMember? _member;
    private string _mobileUrl = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadMember();
    }

    private async Task LoadMember()
    {
        _loading = true;
        try
        {
            _member = await TeamMemberService.GetByIdAsync(Id);
            await UpdateMobileUrl();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Laden: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task UpdateMobileUrl()
    {
        if (_member == null || string.IsNullOrEmpty(_member.MobileToken))
        {
            _mobileUrl = "";
            return;
        }

        var settings = await WerkbankSettingsService.GetSettingsAsync();
        var baseUrl = !string.IsNullOrWhiteSpace(settings.BaseUrl) ? settings.BaseUrl.TrimEnd('/') : "http://localhost:8080";
        _mobileUrl = $"{baseUrl}/m/{_member.MobileToken}";
    }

    private async Task HandleSubmit()
    {
        if (_member == null) return;

        _saving = true;
        _errorMessage = null;

        try
        {
            await TeamMemberService.UpdateAsync(_member);
            Snackbar.Add("Mitarbeiter wurde gespeichert.", Severity.Success);
            NavigationManager.NavigateTo("/team-members");
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task UnlockAccount()
    {
        if (_member == null) return;

        _member.IsLockedByAdmin = false;
        _member.FailedLoginAttempts = 0;
        _member.LockoutUntil = null;

        try
        {
            await TeamMemberService.UpdateAsync(_member);
            Snackbar.Add("Account wurde entsperrt.", Severity.Success);
            await LoadMember();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
        }
    }

    private async Task SendNewInvite()
    {
        if (_member == null) return;

        _sendingInvite = true;
        try
        {
            await InviteService.CreateInviteAsync(_member.Id);
            Snackbar.Add("Neuer Einladungslink wurde gesendet.", Severity.Success);
            await LoadMember();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
        }
        finally
        {
            _sendingInvite = false;
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/team-members");
    }

    // Mobile Access Methods

    private async Task CreateMobileAccess()
    {
        if (_member == null) return;

        try
        {
            var token = await MobileTokenService.CreateMobileAccessAsync(_member.Id);
            Snackbar.Add("Mobiler Zugang wurde erstellt.", Severity.Success);
            await LoadMember();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
        }
    }

    private async Task ResetMobileAccess()
    {
        if (_member == null) return;

        try
        {
            await MobileTokenService.ResetMobileAccessAsync(_member.Id);
            Snackbar.Add("Neuer Zugangslink wurde generiert. Alte PIN wurde gelöscht.", Severity.Warning);
            await LoadMember();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
        }
    }

    private async Task UnlockMobileAccess()
    {
        if (_member == null) return;

        try
        {
            await MobileTokenService.UnlockMobileAccessAsync(_member.Id);
            Snackbar.Add("Mobiler Zugang wurde entsperrt.", Severity.Success);
            await LoadMember();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler: {ex.Message}", Severity.Error);
        }
    }

    private async Task CopyMobileLink()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _mobileUrl);
            Snackbar.Add("Link wurde kopiert.", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Fehler beim Kopieren.", Severity.Error);
        }
    }
}

