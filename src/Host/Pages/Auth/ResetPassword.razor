@page "/reset/{Token}"
@using Kuestencode.Werkbank.Host.Services
@layout EmptyLayout
@inject IPasswordResetService PasswordResetService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Passwort zuruecksetzen - Kuestencode Werkbank</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center" Style="min-height: 100vh;">
    <MudPaper Elevation="4" Class="pa-8 w-100">
        <MudStack AlignItems="AlignItems.Center" Class="mb-6">
            <MudText Typo="Typo.h4">Passwort zuruecksetzen</MudText>
        </MudStack>

        @if (_loading)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        }
        else if (!_tokenValid)
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">
                Dieser Link ist ungueltig oder abgelaufen.
            </MudAlert>
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                      OnClick="@(() => NavigationManager.NavigateTo("/forgot-password"))">
                Neuen Link anfordern
            </MudButton>
        }
        else if (_success)
        {
            <MudAlert Severity="Severity.Success" Class="mb-4">
                Ihr Passwort wurde erfolgreich zurueckgesetzt.
            </MudAlert>
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                      OnClick="@(() => NavigationManager.NavigateTo("/login"))">
                Zur Anmeldung
            </MudButton>
        }
        else
        {
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
            }

            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                Hallo @_memberName, bitte vergeben Sie ein neues Passwort.
            </MudText>

            <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <MudTextField Label="Neues Passwort"
                             @bind-Value="_model.Password"
                             For="@(() => _model.Password)"
                             InputType="@_passwordInputType"
                             Required="true"
                             Class="mb-4"
                             HelperText="Mindestens 8 Zeichen"
                             Adornment="Adornment.End"
                             AdornmentIcon="@_passwordIcon"
                             OnAdornmentClick="TogglePasswordVisibility" />

                <MudTextField Label="Passwort bestaetigen"
                             @bind-Value="_model.ConfirmPassword"
                             For="@(() => _model.ConfirmPassword)"
                             InputType="@_passwordInputType"
                             Required="true"
                             Class="mb-4" />

                <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-2">
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled"
                              Color="Color.Primary" Disabled="@_saving">
                        @if (_saving)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Speichert...</MudText>
                        }
                        else
                        {
                            <MudText>Passwort setzen</MudText>
                        }
                    </MudButton>
                </MudStack>
            </EditForm>
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter] public string Token { get; set; } = string.Empty;

    private ResetPasswordModel _model = new();
    private bool _loading = true;
    private bool _saving;
    private bool _tokenValid;
    private bool _success;
    private string? _errorMessage;
    private string _memberName = string.Empty;
    private bool _passwordVisible;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    protected override async Task OnInitializedAsync()
    {
        await ValidateToken();
    }

    private async Task ValidateToken()
    {
        _loading = true;
        try
        {
            var member = await PasswordResetService.ValidateResetTokenAsync(Token);
            _tokenValid = member != null;
            _memberName = member?.DisplayName ?? string.Empty;
        }
        catch
        {
            _tokenValid = false;
        }
        finally
        {
            _loading = false;
        }
    }

    private void TogglePasswordVisibility()
    {
        _passwordVisible = !_passwordVisible;
        _passwordInputType = _passwordVisible ? InputType.Text : InputType.Password;
        _passwordIcon = _passwordVisible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private async Task HandleSubmit()
    {
        if (_model.Password != _model.ConfirmPassword)
        {
            _errorMessage = "Passwoerter stimmen nicht ueberein.";
            return;
        }

        if (_model.Password.Length < 8)
        {
            _errorMessage = "Passwort muss mindestens 8 Zeichen lang sein.";
            return;
        }

        _saving = true;
        _errorMessage = null;

        try
        {
            await PasswordResetService.ResetPasswordAsync(Token, _model.Password);
            _success = true;
            Snackbar.Add("Passwort wurde zurueckgesetzt.", Severity.Success);
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _saving = false;
        }
    }

    private class ResetPasswordModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Passwort ist erforderlich")]
        [System.ComponentModel.DataAnnotations.MinLength(8, ErrorMessage = "Mindestens 8 Zeichen")]
        public string Password { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Bestaetigung ist erforderlich")]
        [System.ComponentModel.DataAnnotations.Compare(nameof(Password), ErrorMessage = "Passwoerter stimmen nicht ueberein")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
