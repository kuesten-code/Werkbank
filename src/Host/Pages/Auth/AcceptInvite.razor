@page "/invite/{Token}"
@using Kuestencode.Werkbank.Host.Auth
@using Kuestencode.Werkbank.Host.Services
@using System.Text.Json
@layout EmptyLayout
@inject IInviteService InviteService
@inject WerkbankAuthStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar

<PageTitle>Einladung annehmen - Küstencode Werkbank</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center" Style="min-height: 100vh;">
    <MudPaper Elevation="4" Class="pa-8 w-100">
        <MudStack AlignItems="AlignItems.Center" Class="mb-6">
            <MudImage Src="/company/logos/logo_no_name.png" Alt="Küstencode Werkbank Logo" Width="80" Class="mb-3" />
            <MudText Typo="Typo.h4">Küstencode Werkbank</MudText>
        </MudStack>

        @if (_loading)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        }
        else if (!_tokenValid)
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">
                Diese Einladung ist ungültig oder abgelaufen. Bitte wenden Sie sich an Ihren Administrator.
            </MudAlert>
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                      OnClick="@(() => NavigationManager.NavigateTo("/login"))">
                Zur Anmeldung
            </MudButton>
        }
        else if (_success)
        {
            <MudAlert Severity="Severity.Success" Class="mb-4">
                Willkommen! Ihr Konto wurde eingerichtet. Sie werden weitergeleitet...
            </MudAlert>
        }
        else
        {
            <MudText Typo="Typo.body1" Class="mb-4">
                Willkommen <strong>@_memberName</strong>! Bitte vergeben Sie ein Passwort für Ihren Account.
            </MudText>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
            }

            <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <MudTextField Label="Passwort"
                             @bind-Value="_model.Password"
                             For="@(() => _model.Password)"
                             InputType="@_passwordInputType"
                             Required="true"
                             Class="mb-4"
                             HelperText="Mindestens 8 Zeichen"
                             Adornment="Adornment.End"
                             AdornmentIcon="@_passwordIcon"
                             OnAdornmentClick="TogglePasswordVisibility" />

                <MudTextField Label="Passwort bestätigen"
                             @bind-Value="_model.ConfirmPassword"
                             For="@(() => _model.ConfirmPassword)"
                             InputType="@_passwordInputType"
                             Required="true"
                             Class="mb-4" />

                <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-2">
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled"
                              Color="Color.Primary" Disabled="@_saving">
                        @if (_saving)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Einrichtung...</MudText>
                        }
                        else
                        {
                            <MudText>Account einrichten</MudText>
                        }
                    </MudButton>
                </MudStack>
            </EditForm>
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter] public string Token { get; set; } = string.Empty;

    private AcceptInviteModel _model = new();
    private bool _loading = true;
    private bool _saving;
    private bool _tokenValid;
    private bool _success;
    private string? _errorMessage;
    private string _memberName = string.Empty;
    private string _memberEmail = string.Empty;
    private bool _passwordVisible;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    protected override async Task OnInitializedAsync()
    {
        await ValidateToken();
    }

    private async Task ValidateToken()
    {
        _loading = true;
        try
        {
            var member = await InviteService.ValidateInviteTokenAsync(Token);
            _tokenValid = member != null;
            _memberName = member?.DisplayName ?? string.Empty;
            _memberEmail = member?.Email ?? string.Empty;
        }
        catch
        {
            _tokenValid = false;
        }
        finally
        {
            _loading = false;
        }
    }

    private void TogglePasswordVisibility()
    {
        _passwordVisible = !_passwordVisible;
        _passwordInputType = _passwordVisible ? InputType.Text : InputType.Password;
        _passwordIcon = _passwordVisible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private async Task HandleSubmit()
    {
        if (_model.Password != _model.ConfirmPassword)
        {
            _errorMessage = "Passwörter stimmen nicht überein.";
            return;
        }

        if (_model.Password.Length < 8)
        {
            _errorMessage = "Passwort muss mindestens 8 Zeichen lang sein.";
            return;
        }

        _saving = true;
        _errorMessage = null;

        try
        {
            await InviteService.AcceptInviteAsync(Token, _model.Password);

            var resultJson = await JSRuntime.InvokeAsync<string>("werkbankAuth.login", _memberEmail, _model.Password);
            using var envelope = JsonDocument.Parse(resultJson);
            var payloadRaw = envelope.RootElement.GetProperty("payload").GetString() ?? "{}";
            using var payload = JsonDocument.Parse(payloadRaw);

            if (envelope.RootElement.GetProperty("ok").GetBoolean())
            {
                if (payload.RootElement.TryGetProperty("token", out var tokenElement))
                {
                    var token = tokenElement.GetString();
                    if (!string.IsNullOrWhiteSpace(token))
                    {
                        await AuthStateProvider.LoginAsync(token);
                    }
                }

                _success = true;
                Snackbar.Add("Willkommen bei der Küstencode Werkbank!", Severity.Success);
                await Task.Delay(1500);
                NavigationManager.NavigateTo("/", forceLoad: true);
            }
            else
            {
                Snackbar.Add("Account eingerichtet. Bitte melden Sie sich an.", Severity.Success);
                NavigationManager.NavigateTo("/login");
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _saving = false;
        }
    }

    private class AcceptInviteModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Passwort ist erforderlich")]
        [System.ComponentModel.DataAnnotations.MinLength(8, ErrorMessage = "Mindestens 8 Zeichen")]
        public string Password { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Bestätigung ist erforderlich")]
        [System.ComponentModel.DataAnnotations.Compare(nameof(Password), ErrorMessage = "Passwörter stimmen nicht �berein")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
