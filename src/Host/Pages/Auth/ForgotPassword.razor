@page "/forgot-password"
@using Kuestencode.Werkbank.Host.Services
@layout EmptyLayout
@inject IPasswordResetService PasswordResetService
@inject NavigationManager NavigationManager

<PageTitle>Passwort vergessen - Küstencode Werkbank</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center" Style="min-height: 100vh;">
    <MudPaper Elevation="4" Class="pa-8 w-100">
        <MudStack AlignItems="AlignItems.Center" Class="mb-6">
            <MudImage Src="/company/logos/logo_no_name.png" Alt="Küstencode Werkbank Logo" Width="80" Class="mb-3" />
            <MudText Typo="Typo.h4">Passwort vergessen</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Geben Sie Ihre E-Mail-Adresse ein, um einen Link zum Zurücksetzen zu erhalten.
            </MudText>
        </MudStack>

        @if (_sent)
        {
            <MudAlert Severity="Severity.Success" Class="mb-4">
                Falls ein Konto mit dieser E-Mail existiert, wurde ein Link zum Zurücksetzen gesendet.
                Bitte prüfen Sie Ihren Posteingang.
            </MudAlert>

            <MudButton Variant="Variant.Text" Color="Color.Primary"
                      OnClick="@(() => NavigationManager.NavigateTo("/login"))">
                Zurück zur Anmeldung
            </MudButton>
        }
        else
        {
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
            }

            <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <MudTextField Label="E-Mail"
                             @bind-Value="_model.Email"
                             For="@(() => _model.Email)"
                             InputType="InputType.Email"
                             Required="true"
                             Class="mb-4" />

                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mt-2">
                    <MudLink Href="/login" Typo="Typo.body2">Zurück zur Anmeldung</MudLink>
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled"
                              Color="Color.Primary" Disabled="@_loading">
                        @if (_loading)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Sendet...</MudText>
                        }
                        else
                        {
                            <MudText>Link senden</MudText>
                        }
                    </MudButton>
                </MudStack>
            </EditForm>
        }
    </MudPaper>
</MudContainer>

@code {
    private ForgotPasswordModel _model = new();
    private bool _loading;
    private bool _sent;
    private string? _errorMessage;

    private async Task HandleSubmit()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            await PasswordResetService.RequestResetAsync(_model.Email);
            _sent = true;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Fehler: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private class ForgotPasswordModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "E-Mail ist erforderlich")]
        [System.ComponentModel.DataAnnotations.EmailAddress(ErrorMessage = "Ungültige E-Mail-Adresse")]
        public string Email { get; set; } = string.Empty;
    }
}

