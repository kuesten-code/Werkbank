@using Kuestencode.Core.Interfaces
@page "/invoices/create"
@using Kuestencode.Faktura.Services
@using Kuestencode.Faktura.Models
@using System.IO
@inject IInvoiceService InvoiceService
@inject ICustomerService CustomerService
@inject ICompanyService CompanyService
@inject Kuestencode.Faktura.Services.IEmailService EmailService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Neue Faktura - Küstencode Faktura</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h4" GutterBottom="true">Neue Faktura</MudText>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="my-4">@_errorMessage</MudAlert>
        }

        <EditForm Model="@_invoice">
            <DataAnnotationsValidator />

            <!-- Kopfdaten -->
            <MudText Typo="Typo.h6" Class="mt-4 mb-2">Kopfdaten</MudText>
            <MudGrid>
                <MudItem xs="12" sm="4">
                    <MudTextField Label="Rechnungsnummer" @bind-Value="_invoice.InvoiceNumber"
                                 For="@(() => _invoice.InvoiceNumber)" ReadOnly="true" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudDatePicker Label="Rechnungsdatum" @bind-Date="_invoiceDate"
                                  @bind-Date:after="OnServicePeriodChanged"
                                  DateFormat="dd.MM.yyyy" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudDatePicker Label="Fälligkeitsdatum" @bind-Date="_dueDate"
                                  DateFormat="dd.MM.yyyy" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudDatePicker Label="Leistungszeitraum Von" @bind-Date="_servicePeriodStart"
                                  @bind-Date:after="OnServicePeriodChanged"
                                  DateFormat="dd.MM.yyyy"
                                  HelperText="Beginn der Leistungserbringung" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudDatePicker Label="Leistungszeitraum Bis" @bind-Date="_servicePeriodEnd"
                                  @bind-Date:after="OnServicePeriodChanged"
                                  DateFormat="dd.MM.yyyy"
                                  HelperText="Ende der Leistungserbringung" />
                </MudItem>
                <MudItem xs="12">
                    <MudAutocomplete T="Customer"
                        Label="Kunde auswählen"
                        @bind-Value="_selectedCustomer"
                        SearchFunc="@SearchCustomers"
                        ToStringFunc="@(c => c?.Name ?? string.Empty)"
                        ResetValueOnEmptyText="true"
                        CoerceText="true"
                        CoerceValue="false"
                        Error="@_customerError"
                        ErrorText="@_customerErrorText"
                        @ref="_customerAuto">
                        <ItemTemplate Context="customer">
                            <MudText>@customer.Name</MudText>
                            <MudText Typo="Typo.caption">@customer.CustomerNumber - @customer.City</MudText>
                        </ItemTemplate>
                    </MudAutocomplete>
                    <InlineCustomerCreate OnCreated="OnCustomerCreated" />
                </MudItem>
            </MudGrid>

            <!-- Positionen -->
            <MudText Typo="Typo.h6" Class="mt-6 mb-2">Positionen</MudText>
            <MudTable Items="@_invoice.Items" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                <HeaderContent>
                    <MudTh>Beschreibung</MudTh>
                    <MudTh Style="width: 120px; text-align: right">Menge</MudTh>
                    <MudTh Style="width: 120px; text-align: right">Einzelpreis</MudTh>
                    <MudTh Style="width: 120px; text-align: right">Gesamt</MudTh>
                    <MudTh Style="width: 60px"></MudTh>
                </HeaderContent>
                <RowTemplate Context="item">
                    <MudTd DataLabel="Beschreibung">
                        <MudTextField @bind-Value="item.Description" Margin="Margin.Dense"
                                     Variant="Variant.Outlined" Required="true"
                                     Lines="3" AutoGrow="true"
                                     OnBlur="RecalculateTotals" />
                    </MudTd>
                    <MudTd DataLabel="Menge" Style="text-align: right">
                        <MudNumericField @bind-Value="item.Quantity" Margin="Margin.Dense"
                                        Variant="Variant.Outlined" Min="0.001m" Step="1m"
                                        Format="N3" HideSpinButtons="true"
                                        OnBlur="RecalculateTotals" />
                    </MudTd>
                    <MudTd DataLabel="Einzelpreis" Style="text-align: right">
                        <MudNumericField @bind-Value="item.UnitPrice" Margin="Margin.Dense"
                                        Variant="Variant.Outlined" Min="0.01m" Step="1m"
                                        Format="C2" HideSpinButtons="true" Culture="@_culture"
                                        OnBlur="RecalculateTotals" />
                    </MudTd>
                    <MudTd DataLabel="Gesamt" Style="text-align: right">
                        <MudText Typo="Typo.body2">@item.TotalNet.ToString("C2", _culture)</MudText>
                    </MudTd>
                    <MudTd DataLabel="">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                      Color="Color.Error" OnClick="@(() => RemoveItem(item))"
                                      Disabled="@(_invoice.Items.Count <= 1)" />
                    </MudTd>
                </RowTemplate>
            </MudTable>

            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                      StartIcon="@Icons.Material.Filled.Add" OnClick="AddItem" Class="mt-2">
                Position hinzufügen
            </MudButton>

            <!-- Rabatt (optional) -->
            <MudText Typo="Typo.h6" Class="mt-6 mb-2">Rabatt (optional)</MudText>
            <MudCheckBox @bind-Value="_enableDiscount" Label="Rabatt gewähren" Color="Color.Primary"
                        @onchange="OnDiscountToggle" />

            @if (_enableDiscount)
            {
                <MudGrid Class="mt-2">
                    <MudItem xs="12" sm="6">
                        <MudRadioGroup @bind-Value="_invoice.DiscountType" @onchange="RecalculateTotals">
                            <MudRadio Value="@DiscountType.Percentage" Color="Color.Primary">Prozentual</MudRadio>
                            <MudRadio Value="@DiscountType.Absolute" Color="Color.Primary">Betrag</MudRadio>
                        </MudRadioGroup>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        @if (_invoice.DiscountType == DiscountType.Percentage)
                        {
                            <MudNumericField @bind-Value="_invoice.DiscountValue"
                                            Label="Rabatt (%)"
                                            Variant="Variant.Outlined"
                                            Min="0m" Max="100m" Step="1m"
                                            Format="N2" HideSpinButtons="true"
                                            Placeholder="z.B. 10"
                                            OnBlur="RecalculateTotals" />
                        }
                        else
                        {
                            <MudNumericField @bind-Value="_invoice.DiscountValue"
                                            Label="Rabatt (EUR)"
                                            Variant="Variant.Outlined"
                                            Min="0.01m" Step="1m"
                                            Format="C2" HideSpinButtons="true" Culture="@_culture"
                                            Placeholder="z.B. 50,00"
                                            OnBlur="RecalculateTotals" />
                        }
                    </MudItem>
                </MudGrid>

                @if (_discountWarning)
                {
                    <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2">
                        Ungewöhnlich hoher Rabatt (>50%)
                    </MudAlert>
                }
            }

            <!-- Abschläge (optional) -->
            <MudText Typo="Typo.h6" Class="mt-6 mb-2">Abschläge (optional)</MudText>
            @if (_invoice.DownPayments.Count > 0)
            {
                <MudTable Items="@_invoice.DownPayments" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                    <HeaderContent>
                        <MudTh>Beschreibung</MudTh>
                        <MudTh Style="width: 150px; text-align: right">Betrag</MudTh>
                        <MudTh Style="width: 150px">Datum</MudTh>
                        <MudTh Style="width: 60px"></MudTh>
                    </HeaderContent>
                    <RowTemplate Context="downPayment">
                        <MudTd DataLabel="Beschreibung">
                            <MudTextField @bind-Value="downPayment.Description" Margin="Margin.Dense"
                                         Variant="Variant.Outlined" Required="true"
                                         Placeholder="z.B. Anzahlung vom 15.12.2024"
                                         OnBlur="RecalculateTotals" />
                        </MudTd>
                        <MudTd DataLabel="Betrag" Style="text-align: right">
                            <MudNumericField @bind-Value="downPayment.Amount" Margin="Margin.Dense"
                                            Variant="Variant.Outlined" Min="0.01m" Step="1m"
                                            Format="C2" HideSpinButtons="true" Culture="@_culture"
                                            OnBlur="RecalculateTotals" />
                        </MudTd>
                        <MudTd DataLabel="Datum">
                            <MudDatePicker @bind-Date="downPayment.PaymentDate" Margin="Margin.Dense"
                                          Variant="Variant.Outlined" DateFormat="dd.MM.yyyy"
                                          Placeholder="Optional" />
                        </MudTd>
                        <MudTd DataLabel="">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                          Color="Color.Error" OnClick="@(() => RemoveDownPayment(downPayment))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }

            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                      StartIcon="@Icons.Material.Filled.Add" OnClick="AddDownPayment" Class="mt-2">
                Abschlag hinzufügen
            </MudButton>

            <!-- Anhänge (optional) -->
            <MudText Typo="Typo.h6" Class="mt-6 mb-2">Anhänge (optional)</MudText>
            <MudPaper Elevation="0" Class="pa-3 mb-3">
                <MudCheckBox @bind-Value="_attachTimesheet" Label="Tätigkeitsnachweis anhängen" Color="Color.Primary" />
                @if (!_rapportAvailable)
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Rapport Modul ist nicht registriert. Tätigkeitsnachweis kann nicht angehängt werden.</MudText>
                }
                @if (_attachTimesheet)
                {
                    <MudGrid Class="mt-2">
                        <MudItem xs="12" md="4">
                            <MudCheckBox @bind-Value="_timesheetUseInvoicePeriod" @bind-Value:after="OnServicePeriodChanged" Label="Rechnungszeitraum verwenden" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudDatePicker Label="Von" @bind-Date="_timesheetFromDate" Variant="Variant.Outlined" Disabled="_timesheetUseInvoicePeriod" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudDatePicker Label="Bis" @bind-Date="_timesheetToDate" Variant="Variant.Outlined" Disabled="_timesheetUseInvoicePeriod" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudNumericField T="decimal?" Label="Stundensatz (optional)" Variant="Variant.Outlined"
                                             @bind-Value="_timesheetHourlyRate" HideSpinButtons="true" Min="0m" Step="1m" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField Label="Titel" Variant="Variant.Outlined" @bind-Value="_timesheetTitle" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField Label="Dateiname (optional)" Variant="Variant.Outlined" @bind-Value="_timesheetFileName" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudRadioGroup @bind-Value="_timesheetFormat" T="TimesheetAttachmentFormat">
                                <MudRadio Value="@TimesheetAttachmentFormat.Pdf" Color="Color.Primary">PDF</MudRadio>
                                <MudRadio Value="@TimesheetAttachmentFormat.Csv" Color="Color.Primary">CSV</MudRadio>
                            </MudRadioGroup>
                        </MudItem>
                        <MudItem xs="12" Class="d-flex gap-2">
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Disabled="@_timesheetGenerating"
                                      OnClick="CreateTimesheetAttachmentAsync">
                                Tätigkeitsnachweis erstellen
                            </MudButton>
                            @if (_timesheetGenerating)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="ml-2" />
                            }
                        </MudItem>
                    </MudGrid>
                }
            </MudPaper>

            <MudPaper Elevation="0" Class="pa-3">
                <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                               Accept=".pdf,.csv"
                               MaximumFileCount="10"
                               FilesChanged="HandleAttachmentUpload">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.AttachFile"
                                   Size="Size.Small">
                            Datei(en) auswählen
                        </MudButton>
                    </ActivatorContent>
                </MudFileUpload>

                <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Secondary">
                    Erlaubt: PDF und CSV. Maximal 10 Dateien, je 10 MB.
                </MudText>

                @if (_invoice.Attachments.Count > 0)
                {
                    <MudSimpleTable Dense="true" Hover="true" Bordered="true" Class="mt-3">
                        <thead>
                            <tr>
                                <th>Datei</th>
                                <th>Typ</th>
                                <th>Größe</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var attachment in _invoice.Attachments)
                            {
                                <tr>
                                    <td>@attachment.FileName</td>
                                    <td>@attachment.ContentType</td>
                                    <td>@FormatFileSize(attachment.FileSize)</td>
                                    <td style="text-align: right;">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                                      Color="Color.Error" OnClick="@(() => RemoveAttachment(attachment))" />
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
            </MudPaper>

            <!-- Summen -->
            <MudPaper Elevation="2" Class="pa-4 mt-6" Style="max-width: 400px; margin-left: auto;">
                <MudText Typo="Typo.h6" GutterBottom="true">Summen</MudText>
                <MudStack Spacing="2">
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText>Nettosumme:</MudText>
                        <MudText>@_totalNet.ToString("C2", _culture)</MudText>
                    </MudStack>
                    @if (_discountAmount > 0)
                    {
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText>@GetDiscountLabel():</MudText>
                            <MudText Color="Color.Error">-@_discountAmount.ToString("C2", _culture)</MudText>
                        </MudStack>
                        <MudDivider />
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText>Zwischensumme:</MudText>
                            <MudText>@_totalNetAfterDiscount.ToString("C2", _culture)</MudText>
                        </MudStack>
                    }
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText>@(_company?.IsKleinunternehmer == true ? "MwSt (0%, §19 UStG):" : "MwSt (19%):")</MudText>
                        <MudText>@_totalVat.ToString("C2", _culture)</MudText>
                    </MudStack>
                    <MudDivider />
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.subtitle1">Bruttosumme:</MudText>
                        <MudText Typo="Typo.subtitle1">@_totalGross.ToString("C2", _culture)</MudText>
                    </MudStack>
                    @if (_totalDownPayments > 0)
                    {
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText>Abschläge:</MudText>
                            <MudText Color="Color.Error">-@_totalDownPayments.ToString("C2", _culture)</MudText>
                        </MudStack>
                        <MudDivider DividerType="DividerType.FullWidth" Style="border-width: 2px;" />
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.h6">Zu zahlen:</MudText>
                            <MudText Typo="Typo.h6">@_amountDue.ToString("C2", _culture)</MudText>
                        </MudStack>
                        @if (_amountDue < 0)
                        {
                            <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2">
                                Warnung: Abschläge übersteigen Rechnungsbetrag
                            </MudAlert>
                        }
                    }
                    @if (_company?.IsKleinunternehmer == true)
                    {
                        <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                            §19 UStG - Kleinunternehmer (keine MwSt)
                        </MudAlert>
                    }
                </MudStack>
            </MudPaper>

            <!-- Notizen -->
            <MudText Typo="Typo.h6" Class="mt-6 mb-2">Notizen (optional)</MudText>
            <MudTextField @bind-Value="_invoice.Notes" Lines="4" Variant="Variant.Outlined" />

            <!-- Actions -->
            <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-6 gap-2">
                <MudButton Variant="Variant.Filled" Color="Color.Default" OnClick="Cancel">
                    Abbrechen
                </MudButton>

                <MudButton Variant="Variant.Filled" Color="Color.Secondary"
                        Disabled="@_saving"
                        OnClick="@(() => SaveAsync(true))">
                    Als Entwurf speichern
                </MudButton>

                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                        Disabled="@_saving"
                        OnClick="@(() => SaveAndSendAsync(false))">
                    @if (_saving)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Speichert...</MudText>
                    }
                    else
                    {
                        <MudText>Faktura versenden</MudText>
                    }
                </MudButton>
            </MudStack>
        </EditForm>
    </MudPaper>
</MudContainer>

