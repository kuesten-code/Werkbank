@page "/invoices"
@using Kuestencode.Faktura.Services
@using Kuestencode.Faktura.Models
@using Microsoft.AspNetCore.WebUtilities
@inject IInvoiceService InvoiceService
@inject IPdfGeneratorService PdfGeneratorService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<PageTitle>Fakturen - Küstencode Faktura</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Fakturen</MudText>

    <MudPaper Class="pa-4 mt-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudTextField @bind-Value="_searchString" Placeholder="Rechnung oder Kunde suchen"
                         Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                         IconSize="Size.Medium" Class="mt-0" Immediate="true" Style="max-width: 400px;" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                      StartIcon="@Icons.Material.Filled.Add" OnClick="CreateInvoice">
                Neue Faktura
            </MudButton>
        </MudStack>

        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" Class="mb-4"
                @bind-ActivePanelIndex="_activeTabIndex" @bind-ActivePanelIndex:after="OnTabChanged">
            <MudTabPanel Text="Alle" Icon="@Icons.Material.Filled.List" />
            <MudTabPanel Text="Entwurf" Icon="@Icons.Material.Filled.Edit" BadgeData="@_draftCount" BadgeColor="Color.Default" />
            <MudTabPanel Text="Versendet" Icon="@Icons.Material.Filled.Send" BadgeData="@_sentCount" BadgeColor="Color.Info" />
            <MudTabPanel Text="Beglichen" Icon="@Icons.Material.Filled.CheckCircle" BadgeData="@_paidCount" BadgeColor="Color.Success" />
            <MudTabPanel Text="Überfällig" Icon="@Icons.Material.Filled.Warning" BadgeData="@_overdueCount" BadgeColor="Color.Error" />
        </MudTabs>

        <MudTable Items="@_filteredInvoices" Hover="true" Breakpoint="Breakpoint.Sm"
                 Loading="@_loading" LoadingProgressColor="Color.Info"
                 RowsPerPage="10">
            <HeaderContent>
                <MudTh>Rechnungsnr.</MudTh>
                <MudTh>Datum</MudTh>
                <MudTh>Kunde</MudTh>
                <MudTh Style="text-align: right">Betrag</MudTh>
                <MudTh>Status</MudTh>
                <MudTh Style="text-align: right">Aktionen</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Rechnungsnr.">@context.InvoiceNumber</MudTd>
                <MudTd DataLabel="Datum">@context.InvoiceDate.ToString("dd.MM.yyyy")</MudTd>
                <MudTd DataLabel="Kunde">@context.Customer?.Name</MudTd>
                <MudTd DataLabel="Betrag" Style="text-align: right">@context.TotalGross.ToString("C2", _culture)</MudTd>
                <MudTd DataLabel="Status">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                            @GetStatusText(context.Status)
                        </MudChip>
                        @if (context.PrintCount > 0 && context.PrintedAt.HasValue)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Print" Size="Size.Small" Color="Color.Default" title="Gedruckt" />
                        }
                        @if (context.EmailSendCount > 0 && context.EmailSentAt.HasValue)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Color="Color.Info" title="Per E-Mail versendet" />
                        }
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Aktionen" Style="text-align: right">
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                  Color="Color.Info" Size="Size.Small"
                                  OnClick="@(() => ViewInvoice(context.Id))" />
                    @if (context.Status == InvoiceStatus.Draft)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                      Color="Color.Primary" Size="Size.Small"
                                      OnClick="@(() => EditInvoice(context.Id))" />
                    }
                    @if (context.Status == InvoiceStatus.Sent)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.CheckCircle"
                                      Color="Color.Success" Size="Size.Small"
                                      OnClick="@(() => MarkAsPaid(context))" />
                    }
                    @if (context.Status != InvoiceStatus.Draft)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.PictureAsPdf"
                                      Color="Color.Default" Size="Size.Small"
                                      OnClick="@(() => DownloadPdf(context))" />
                    }
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudContainer>
