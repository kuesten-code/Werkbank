@using Kuestencode.Core.Interfaces
@page "/settings/pdf-anpassung"
@using Kuestencode.Faktura.Models
@using Kuestencode.Faktura.Services
@using Kuestencode.Shared.UI.Components
@inject ICompanyService CompanyService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>PDF-Anpassung - Küstencode Faktura</PageTitle>

<div style="width: 100%; padding: 24px;">
    <div style="display: flex; gap: 24px; flex-wrap: wrap;">
        <!-- Settings Panel - Mobile only -->
        <div style="flex: 0 0 100%; max-width: 100%;" class="d-lg-none">
            <MudPaper Elevation="2" Class="pa-6">
                <MudText Typo="Typo.h4" GutterBottom="true">PDF-Anpassung</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
                    Passen Sie das Erscheinungsbild Ihrer Rechnungs-PDFs an.
                </MudText>

                @if (_loading)
                {
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                }
                else
                {
                    <!-- Mobile content will be shown here -->
                    <MudText>Mobile Ansicht - Content wird von Desktop übernommen</MudText>
                }
            </MudPaper>
        </div>

        <!-- Settings Panel - Desktop only -->
        <div style="flex: 0 0 45%; max-width: 45%;" class="d-none d-lg-block">
            <MudPaper Elevation="2" Class="pa-6">
                <MudText Typo="Typo.h4" GutterBottom="true">PDF-Anpassung</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
                    Passen Sie das Erscheinungsbild Ihrer Rechnungs-PDFs an.
                </MudText>

                @if (_loading)
                {
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                }
                else
                {
                    <!-- Layout-Auswahl -->
                    <MudText Typo="Typo.h6" Class="mt-6 mb-3">Layout</MudText>
                    <MudRadioGroup @bind-Value="_company.PdfLayout">
                        <MudCard Outlined="true" Class="mb-3" Style="@(_company.PdfLayout == PdfLayout.Klar ? "border: 2px solid var(--mud-palette-primary);" : "")">
                            <MudCardContent>
                                <MudRadio Value="PdfLayout.Klar" Color="Color.Primary">
                                    <MudText Typo="Typo.h6">Klar <MudChip T="string" Size="Size.Small" Variant="Variant.Text">Default</MudChip></MudText>
                                </MudRadio>
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="ml-8">
                                    Minimalistisch, text-dominiert, maximale Lesbarkeit.
                                </MudText>
                            </MudCardContent>
                        </MudCard>

                        <MudCard Outlined="true" Class="mb-3" Style="@(_company.PdfLayout == PdfLayout.Strukturiert ? "border: 2px solid var(--mud-palette-primary);" : "")">
                            <MudCardContent>
                                <MudRadio Value="PdfLayout.Strukturiert" Color="Color.Primary">
                                    <MudText Typo="Typo.h6">Strukturiert</MudText>
                                </MudRadio>
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="ml-8">
                                    Mit Boxen und Trennlinien für mehr Übersichtlichkeit.
                                </MudText>
                            </MudCardContent>
                        </MudCard>

                        <MudCard Outlined="true" Class="mb-3" Style="@(_company.PdfLayout == PdfLayout.Betont ? "border: 2px solid var(--mud-palette-primary);" : "")">
                            <MudCardContent>
                                <MudRadio Value="PdfLayout.Betont" Color="Color.Primary">
                                    <MudText Typo="Typo.h6">Betont</MudText>
                                </MudRadio>
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="ml-8">
                                    Farbiger Header und hervorgehobener Betrag, visuell stärker.
                                </MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudRadioGroup>

                    <!-- Farben -->
                    <MudText Typo="Typo.h6" Class="mt-6 mb-3">Farben</MudText>
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Primärfarbe</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
                                Wird für Überschriften und Hervorhebungen verwendet.
                            </MudText>

                            <MudColorPicker @bind-Value="_primaryColorValue"
                                           ColorPickerMode="ColorPickerMode.RGB"
                                           disablealpha="true"
                                           Placeholder="Farbe wählen"
                                           Class="mb-3" />

                            <MudText Typo="Typo.caption" Class="mb-2">Vorschläge:</MudText>
                            <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                                <MudChip T="string" Size="Size.Small" OnClick='() => SetPrimaryColor("#0F2A3D")'
                                        Style="background-color: #0F2A3D; color: white;">Küstencode Primär</MudChip>
                                <MudChip T="string" Size="Size.Small" OnClick='() => SetPrimaryColor("#1f3a5f")'
                                        Style="background-color: #1f3a5f; color: white;">Nordisch Blau</MudChip>
                                <MudChip T="string" Size="Size.Small" OnClick='() => SetPrimaryColor("#374151")'
                                        Style="background-color: #374151; color: white;">Anthrazit</MudChip>
                                <MudChip T="string" Size="Size.Small" OnClick='() => SetPrimaryColor("#065f46")'
                                        Style="background-color: #065f46; color: white;">Dunkelgrün</MudChip>
                                <MudChip T="string" Size="Size.Small" OnClick='() => SetPrimaryColor("#0c4a6e")'
                                        Style="background-color: #0c4a6e; color: white;">Tiefseeblau</MudChip>
                                <MudChip T="string" Size="Size.Small" OnClick='() => SetPrimaryColor("#334155")'
                                        Style="background-color: #334155; color: white;">Schiefer</MudChip>
                            </MudStack>
                        </MudItem>

                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Akzentfarbe</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
                                Wird sparsam zur Betonung eingesetzt.
                            </MudText>

                            <MudColorPicker @bind-Value="_accentColorValue"
                                           ColorPickerMode="ColorPickerMode.RGB"
                                           disablealpha="true"
                                           Placeholder="Farbe wählen"
                                           Class="mb-3" />

                            <MudText Typo="Typo.caption" Class="mb-2">Vorschläge:</MudText>
                            <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                                <MudChip T="string" Size="Size.Small" OnClick='() => SetAccentColor("#3FA796")'
                                        Style="background-color: #3FA796; color: white;">Salzgrün</MudChip>
                                <MudChip T="string" Size="Size.Small" OnClick='() => SetAccentColor("#6b7280")'
                                        Style="background-color: #6b7280; color: white;">Hellgrau</MudChip>
                                <MudChip T="string" Size="Size.Small" OnClick='() => SetAccentColor("#3b82f6")'
                                        Style="background-color: #3b82f6; color: white;">Mittelblau</MudChip>
                                <MudChip T="string" Size="Size.Small" OnClick='() => SetAccentColor("#ea580c")'
                                        Style="background-color: #ea580c; color: white;">Orange</MudChip>
                                <MudChip T="string" Size="Size.Small" OnClick='() => SetAccentColor("#16a34a")'
                                        Style="background-color: #16a34a; color: white;">Grün</MudChip>
                                <MudChip T="string" Size="Size.Small" OnClick='() => SetAccentColor("#7c3aed")'
                                        Style="background-color: #7c3aed; color: white;">Violett</MudChip>
                            </MudStack>
                        </MudItem>
                    </MudGrid>

                    @if (_company.PdfPrimaryColor == _company.PdfAccentColor)
                    {
                        <MudAlert Severity="Severity.Warning" Class="mt-3">
                            Primär- und Akzentfarbe sollten sich unterscheiden.
                        </MudAlert>
                    }

                    <!-- Textanpassung -->
                    <MudText Typo="Typo.h6" Class="mt-6 mb-3">Textanpassung (optional)</MudText>
                    <MudGrid>
                        <MudItem xs="12">
                            <MudTextField Label="Header-Text"
                                         @bind-Value="_company.PdfHeaderText"
                                         Lines="3"
                                         Placeholder="Optionaler Text im Header-Bereich"
                                         HelperText="Max. 500 Zeichen"
                                         Counter="500"
                                         MaxLength="500" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField Label="Footer-Text"
                                         @bind-Value="_company.PdfFooterText"
                                         Lines="3"
                                         Placeholder="Optionaler zusätzlicher Text im Footer"
                                         HelperText="Max. 1000 Zeichen"
                                         Counter="1000"
                                         MaxLength="1000" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField Label="Zahlungshinweis"
                                         @bind-Value="_company.PdfPaymentNotice"
                                         Lines="3"
                                         Placeholder="Bitte überweisen Sie den Betrag bis zum {{Faelligkeitsdatum}} auf unser Konto."
                                         HelperText="Max. 500 Zeichen"
                                         Counter="500"
                                         MaxLength="500" />
                        </MudItem>
                    </MudGrid>

                    <MudAlert Severity="Severity.Info" Class="mt-3">
                        <strong>Verfügbare Platzhalter:</strong><br />
                        <code>{{Firmenname}}</code> - Ihr Firmenname<br />
                        <code>{{Rechnungsnummer}}</code> - Rechnungsnummer<br />
                        <code>{{Rechnungsdatum}}</code> - Rechnungsdatum<br />
                        <code>{{Faelligkeitsdatum}}</code> - Fälligkeitsdatum<br />
                        <code>{{Rechnungsbetrag}}</code> - Rechnungsbetrag<br />
                        <code>{{Kundenname}}</code> - Kundenname<br /><br />
                        <MudText Typo="Typo.caption">Platzhalter werden beim Generieren automatisch ersetzt.</MudText>
                    </MudAlert>

                    <!-- Aktionen -->
                    <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-6">
                        <MudButton Variant="Variant.Text"
                                  Color="Color.Default"
                                  OnClick="ResetToDefaults">
                            Auf Standard zurücksetzen
                        </MudButton>
                        <MudButton ButtonType="ButtonType.Button"
                                  Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  Disabled="@_saving"
                                  OnClick="HandleSubmit">
                            @if (_saving)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Speichern...</MudText>
                            }
                            else
                            {
                                <MudText>Speichern</MudText>
                            }
                        </MudButton>
                    </MudStack>
                }
            </MudPaper>
        </div>

        <!-- Live Preview Panel - Mobile only -->
        <div style="flex: 0 0 100%; max-width: 100%;" class="d-lg-none">
            <MudPaper Elevation="2" Class="pa-6">
                <MudText Typo="Typo.h6" Class="mb-3">Live-Vorschau</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-4">
                    Beispiel-Rechnung mit aktuellen Einstellungen
                </MudText>

                @if (!_loading)
                {
                    <div style="max-height: 100vh; overflow-y: auto;">
                        <Kuestencode.Shared.UI.Components.PdfPreview GeneratePdf="@GeneratePreviewPdf" />
                    </div>
                }
            </MudPaper>
        </div>

        <!-- Live Preview Panel - Desktop only -->
        <div style="flex: 0 0 45%; max-width: 45%;" class="d-none d-lg-block">
            <div style="position: sticky; top: 20px;">
                <MudPaper Elevation="2" Class="pa-6">
                    <MudText Typo="Typo.h6" Class="mb-3">Live-Vorschau</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-4">
                        Beispiel-Rechnung mit aktuellen Einstellungen
                    </MudText>

                    @if (!_loading)
                    {
                        <div style="max-height: calc(100vh - 200px); overflow-y: auto;">
                            <Kuestencode.Shared.UI.Components.PdfPreview GeneratePdf="@GeneratePreviewPdf" />
                        </div>
                    }
                </MudPaper>
            </div>
        </div>
    </div>
</div>
