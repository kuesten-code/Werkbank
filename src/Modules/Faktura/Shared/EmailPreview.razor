@using Kuestencode.Faktura.Models
@using Kuestencode.Faktura.Services
@inject IWebHostEnvironment Environment

<div class="email-preview-surface">
    @if (_loading)
    {
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; min-height: 600px;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    }
    else if (!string.IsNullOrEmpty(_error))
    {
        <MudAlert Severity="Severity.Error">@_error</MudAlert>
    }
    else
    {
        <div class="email-preview-frame">
            @((MarkupString)_previewHtml)
        </div>
    }
</div>

@code {
    [Parameter]
    public Company Company { get; set; } = default!;

    private bool _loading = true;
    private string _error = string.Empty;
    private string _previewHtml = string.Empty;
    private System.Threading.Timer? _debounceTimer;

    protected override void OnInitialized()
    {
        GeneratePreview();
    }

    protected override void OnParametersSet()
    {
        // Debounce preview updates
        _debounceTimer?.Dispose();
        _debounceTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                GeneratePreview();
                StateHasChanged();
            });
        }, null, 500, Timeout.Infinite);
    }

    private void GeneratePreview()
    {
        _loading = true;
        _error = string.Empty;

        try
        {
            var templateName = Company.EmailLayout switch
            {
                EmailLayout.Klar => Path.Combine(Environment.WebRootPath, "templates", "EmailTemplateKlar.html"),
                EmailLayout.Strukturiert => Path.Combine(Environment.WebRootPath, "templates", "EmailTemplateStrukturiert.html"),
                EmailLayout.Betont => Path.Combine(Environment.WebRootPath, "templates", "EmailTemplateBetont.html"),
                _ => "EmailTemplateKlar.html"
            };

            var templatePath = Path.Combine(Environment.WebRootPath, "templates", templateName);

            if (!File.Exists(templatePath))
            {
                _error = "E-Mail-Template nicht gefunden";
                return;
            }

            var template = File.ReadAllText(templatePath);

            // Replace colors
            template = template.Replace("{{PRIMARY_COLOR}}", Company.EmailPrimaryColor);
            template = template.Replace("{{ACCENT_COLOR}}", Company.EmailAccentColor);

            // Replace placeholders with example data
            var greeting = string.IsNullOrWhiteSpace(Company.EmailGreeting)
                ? "Sehr geehrte Damen und Herren,\n\nanbei erhalten Sie Ihre Rechnung."
                : Company.EmailGreeting;

            var closing = string.IsNullOrWhiteSpace(Company.EmailClosing)
                ? "Mit freundlichen Grüßen\n\n{{Firmenname}}"
                : Company.EmailClosing;

            var firmenname = !string.IsNullOrEmpty(Company.BusinessName)
                ? Company.BusinessName
                : Company.OwnerFullName;

            greeting = ReplaceEmailPlaceholders(greeting, "RE-2025-001", "31.01.2025", firmenname);
            closing = ReplaceEmailPlaceholders(closing, "RE-2025-001", "31.01.2025", firmenname);

            template = template.Replace("{{GREETING}}", greeting.Replace("\n", "<br>"));
            template = template.Replace("{{CLOSING}}", closing.Replace("\n", "<br>"));
            template = template.Replace("{{INVOICE_NUMBER}}", "RE-2025-001");
            template = template.Replace("{{INVOICE_DATE}}", "17.01.2025");
            template = template.Replace("{{DUE_DATE}}", "31.01.2025");
            template = template.Replace("{{TOTAL_AMOUNT}}", "1.190,00 €");

            _previewHtml = template;
        }
        catch (Exception ex)
        {
            _error = $"Fehler beim Generieren der Vorschau: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private string ReplaceEmailPlaceholders(string text, string invoiceNumber, string dueDate, string firmenname)
    {
        return text
            .Replace("{{Firmenname}}", firmenname)
            .Replace("{{Rechnungsnummer}}", invoiceNumber)
            .Replace("{{Faelligkeitsdatum}}", dueDate);
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
