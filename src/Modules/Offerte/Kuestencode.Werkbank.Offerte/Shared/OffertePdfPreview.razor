@using Kuestencode.Core.Models
@using Kuestencode.Core.Enums
@using Kuestencode.Werkbank.Offerte.Domain.Entities

<div class="pdf-preview-surface">
    @if (_loading)
    {
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; min-height: 600px;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    }
    else if (!string.IsNullOrEmpty(_error))
    {
        <MudAlert Severity="Severity.Error">@_error</MudAlert>
    }
    else
    {
        <div class="pdf-preview-frame" style="background: white; padding: 40px; border: 1px solid #ddd; min-height: 800px;">
            @((MarkupString)_previewHtml)
        </div>
    }
</div>

@code {
    [Parameter]
    public OfferteSettings Settings { get; set; } = default!;

    [Parameter]
    public Company Company { get; set; } = default!;

    private bool _loading = true;
    private string _error = string.Empty;
    private string _previewHtml = string.Empty;
    private System.Threading.Timer? _debounceTimer;

    protected override void OnInitialized()
    {
        GeneratePreview();
    }

    protected override void OnParametersSet()
    {
        _debounceTimer?.Dispose();
        _debounceTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                GeneratePreview();
                StateHasChanged();
            });
        }, null, 500, Timeout.Infinite);
    }

    private void GeneratePreview()
    {
        _loading = true;
        _error = string.Empty;

        try
        {
            var firmenname = !string.IsNullOrEmpty(Company.BusinessName)
                ? Company.BusinessName
                : Company.OwnerFullName;

            var headerText = string.IsNullOrWhiteSpace(Settings.PdfHeaderText)
                ? ""
                : "<div style='color: #666; font-size: 12px; margin-bottom: 10px;'>" + Settings.PdfHeaderText + "</div>";

            var footerText = string.IsNullOrWhiteSpace(Settings.PdfFooterText)
                ? ""
                : Settings.PdfFooterText;

            var validityNotice = string.IsNullOrWhiteSpace(Settings.PdfValidityNotice)
                ? "Dieses Angebot ist gültig bis zum 15.02.2025."
                : Settings.PdfValidityNotice
                    .Replace("{{Gueltigkeitsdatum}}", "15.02.2025")
                    .Replace("{{Angebotsnummer}}", "AN-2025-001")
                    .Replace("{{Firmenname}}", firmenname);

            var primaryColor = Settings.PdfPrimaryColor;
            var accentColor = Settings.PdfAccentColor;
            var isBetont = Settings.PdfLayout == PdfLayout.Betont;
            var isStrukturiert = Settings.PdfLayout == PdfLayout.Strukturiert;

            var headerBgStyle = isBetont
                ? "background: " + primaryColor + "; color: white; padding: 20px; margin: -40px -40px 20px -40px;"
                : "";
            var headerTextColor = isBetont ? "white" : primaryColor;
            var subTextColor = isBetont ? "#ddd" : "#666";
            var addressBorderStyle = isStrukturiert
                ? "border-left: 3px solid " + accentColor + "; padding-left: 15px;"
                : "";
            var tableHeaderBg = isStrukturiert ? "background: #f5f5f5;" : "";
            var sumBoxStyle = isBetont
                ? "background: " + accentColor + "; color: white; padding: 15px;"
                : "";
            var sumLabelStyle = isBetont ? "" : "color: #666;";
            var sumTextColor = isBetont ? "white" : primaryColor;
            var footerHtml = string.IsNullOrEmpty(footerText)
                ? ""
                : "<div style='margin-top: 10px; text-align: center;'>" + footerText + "</div>";
            var vatHtml = string.IsNullOrEmpty(Company.VatId)
                ? ""
                : "USt-IdNr.: " + Company.VatId;

            _previewHtml = @"
<div style='font-family: Arial, sans-serif;'>
    <div style='" + headerBgStyle + @"'>
        " + headerText + @"
        <div style='display: flex; justify-content: space-between; align-items: flex-start;'>
            <div>
                <div style='font-size: 24px; font-weight: bold; color: " + headerTextColor + @";'>" + firmenname + @"</div>
                <div style='font-size: 12px; color: " + subTextColor + @"; margin-top: 5px;'>
                    " + Company.Address + @"<br>" + Company.PostalCode + " " + Company.City + @"
                </div>
            </div>
            <div style='text-align: right;'>
                <div style='font-size: 28px; font-weight: bold; color: " + headerTextColor + @";'>ANGEBOT</div>
                <div style='font-size: 14px; color: " + subTextColor + @"; margin-top: 5px;'>AN-2025-001</div>
            </div>
        </div>
    </div>

    <div style='margin: 30px 0; " + addressBorderStyle + @"'>
        <div style='font-size: 12px; color: #666; margin-bottom: 5px;'>Angebot an:</div>
        <div style='font-weight: bold;'>Musterfirma GmbH</div>
        <div>Musterstraße 123</div>
        <div>12345 Musterstadt</div>
    </div>

    <div style='display: flex; gap: 30px; margin-bottom: 30px;'>
        <div>
            <div style='font-size: 12px; color: #666;'>Angebotsdatum</div>
            <div style='font-weight: bold;'>17.01.2025</div>
        </div>
        <div>
            <div style='font-size: 12px; color: #666;'>Gültig bis</div>
            <div style='font-weight: bold;'>15.02.2025</div>
        </div>
    </div>

    <table style='width: 100%; border-collapse: collapse; margin-bottom: 30px;'>
        <thead>
            <tr style='" + tableHeaderBg + @" border-bottom: 2px solid " + primaryColor + @";'>
                <th style='text-align: left; padding: 10px 5px; color: " + primaryColor + @";'>Beschreibung</th>
                <th style='text-align: right; padding: 10px 5px; color: " + primaryColor + @";'>Menge</th>
                <th style='text-align: right; padding: 10px 5px; color: " + primaryColor + @";'>Einzelpreis</th>
                <th style='text-align: right; padding: 10px 5px; color: " + primaryColor + @";'>Gesamt</th>
            </tr>
        </thead>
        <tbody>
            <tr style='border-bottom: 1px solid #eee;'>
                <td style='padding: 10px 5px;'>Webentwicklung - Projektphase 1</td>
                <td style='text-align: right; padding: 10px 5px;'>20 Std.</td>
                <td style='text-align: right; padding: 10px 5px;'>95,00 €</td>
                <td style='text-align: right; padding: 10px 5px;'>1.900,00 €</td>
            </tr>
            <tr style='border-bottom: 1px solid #eee;'>
                <td style='padding: 10px 5px;'>Design-Konzept</td>
                <td style='text-align: right; padding: 10px 5px;'>1</td>
                <td style='text-align: right; padding: 10px 5px;'>550,00 €</td>
                <td style='text-align: right; padding: 10px 5px;'>550,00 €</td>
            </tr>
        </tbody>
    </table>

    <div style='text-align: right; margin-bottom: 30px;'>
        <div style='display: inline-block; " + sumBoxStyle + @"'>
            <div style='font-size: 12px; " + sumLabelStyle + @"'>Gesamtbetrag (Netto)</div>
            <div style='font-size: 24px; font-weight: bold; color: " + sumTextColor + @";'>2.450,00 €</div>
        </div>
    </div>

    <div style='background: #f9f9f9; padding: 15px; border-left: 3px solid " + accentColor + @"; margin-bottom: 30px;'>
        " + validityNotice + @"
    </div>

    <div style='border-top: 1px solid #ddd; padding-top: 20px; font-size: 11px; color: #666;'>
        <div style='display: flex; justify-content: space-between;'>
            <div>" + firmenname + @"<br>" + Company.Email + @"</div>
            <div style='text-align: center;'>Steuernummer: " + Company.TaxNumber + @"<br>" + vatHtml + @"</div>
            <div style='text-align: right;'>" + Company.BankName + @"<br>IBAN: " + Company.BankAccount + @"</div>
        </div>
        " + footerHtml + @"
    </div>
</div>";
        }
        catch (Exception ex)
        {
            _error = "Fehler beim Generieren der Vorschau: " + ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
