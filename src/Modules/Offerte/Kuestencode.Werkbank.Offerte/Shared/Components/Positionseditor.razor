@* Positionseditor component for editing Angebot positions *@

<MudTable Items="@Positionen" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="0">
    <HeaderContent>
        <MudTh Style="width: 60px">Pos.</MudTh>
        <MudTh>Beschreibung</MudTh>
        <MudTh Style="width: 100px; text-align: right">Menge</MudTh>
        <MudTh Style="width: 120px; text-align: right">Einzelpreis</MudTh>
        @if (!IsKleinunternehmer)
        {
            <MudTh Style="width: 80px; text-align: right">MwSt</MudTh>
        }
        <MudTh Style="width: 80px; text-align: right">Rabatt</MudTh>
        <MudTh Style="width: 120px; text-align: right">Gesamt</MudTh>
        <MudTh Style="width: 100px"></MudTh>
    </HeaderContent>
    <RowTemplate Context="position">
        <MudTd DataLabel="Pos.">@position.Position</MudTd>
        <MudTd DataLabel="Beschreibung">
            <MudTextField @bind-Value="position.Text" Margin="Margin.Dense"
                         Variant="Variant.Outlined" Required="true"
                         Lines="2" AutoGrow="true" Disabled="@Readonly"
                         OnBlur="@(() => OnPositionChanged.InvokeAsync())" />
        </MudTd>
        <MudTd DataLabel="Menge" Style="text-align: right">
            <MudNumericField @bind-Value="position.Menge" Margin="Margin.Dense"
                            Variant="Variant.Outlined" Min="0.001m" Step="1m"
                            Format="N3" HideSpinButtons="true" Disabled="@Readonly"
                            OnBlur="@(() => OnPositionChanged.InvokeAsync())" />
        </MudTd>
        <MudTd DataLabel="Einzelpreis" Style="text-align: right">
            <MudNumericField @bind-Value="position.Einzelpreis" Margin="Margin.Dense"
                            Variant="Variant.Outlined" Min="0.00m" Step="1m"
                            Format="C2" HideSpinButtons="true" Culture="@_culture" Disabled="@Readonly"
                            OnBlur="@(() => OnPositionChanged.InvokeAsync())" />
        </MudTd>
        @if (!IsKleinunternehmer)
        {
            <MudTd DataLabel="MwSt" Style="text-align: right">
                <MudSelect @bind-Value="position.Steuersatz" Margin="Margin.Dense"
                          Variant="Variant.Outlined" Disabled="@Readonly"
                          Dense="true">
                    <MudSelectItem Value="0m">0%</MudSelectItem>
                    <MudSelectItem Value="7m">7%</MudSelectItem>
                    <MudSelectItem Value="19m">19%</MudSelectItem>
                </MudSelect>
            </MudTd>
        }
        <MudTd DataLabel="Rabatt" Style="text-align: right">
            <MudNumericField @bind-Value="position.Rabatt" Margin="Margin.Dense"
                            Variant="Variant.Outlined" Min="0m" Max="100m" Step="1m"
                            Format="N2" HideSpinButtons="true" Disabled="@Readonly"
                            Placeholder="0"
                            OnBlur="@(() => OnPositionChanged.InvokeAsync())" />
        </MudTd>
        <MudTd DataLabel="Gesamt" Style="text-align: right">
            <MudText Typo="Typo.body2">@position.Nettosumme.ToString("C2", _culture)</MudText>
        </MudTd>
        <MudTd DataLabel="">
            @if (!Readonly)
            {
                <MudStack Row="true" Spacing="0">
                    <MudIconButton Icon="@Icons.Material.Filled.ArrowUpward" Size="Size.Small"
                                  OnClick="@(() => MovePositionUp(position))"
                                  Disabled="@(position.Position <= 1)" />
                    <MudIconButton Icon="@Icons.Material.Filled.ArrowDownward" Size="Size.Small"
                                  OnClick="@(() => MovePositionDown(position))"
                                  Disabled="@(position.Position >= Positionen.Count)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                  Color="Color.Error"
                                  OnClick="@(() => RemovePosition(position))"
                                  Disabled="@(Positionen.Count <= 1)" />
                </MudStack>
            }
        </MudTd>
    </RowTemplate>
</MudTable>

@if (!Readonly)
{
    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
              StartIcon="@Icons.Material.Filled.Add" OnClick="AddPosition" Class="mt-2">
        Position hinzuf√ºgen
    </MudButton>
}

@code {
    private readonly CultureInfo _culture = new CultureInfo("de-DE");

    [Parameter]
    public List<Angebotsposition> Positionen { get; set; } = new();

    [Parameter]
    public EventCallback<List<Angebotsposition>> PositionenChanged { get; set; }

    [Parameter]
    public EventCallback OnPositionChanged { get; set; }

    [Parameter]
    public bool Readonly { get; set; } = false;

    [Parameter]
    public bool IsKleinunternehmer { get; set; } = false;

    private decimal DefaultSteuersatz => IsKleinunternehmer ? 0m : 19m;

    private async Task AddPosition()
    {
        var newPosition = new Angebotsposition
        {
            Id = Guid.NewGuid(),
            Position = Positionen.Count + 1,
            Text = "",
            Menge = 1,
            Einzelpreis = 0,
            Steuersatz = DefaultSteuersatz
        };

        Positionen.Add(newPosition);
        await PositionenChanged.InvokeAsync(Positionen);
        await OnPositionChanged.InvokeAsync();
    }

    private async Task RemovePosition(Angebotsposition position)
    {
        Positionen.Remove(position);
        ReorderPositions();
        await PositionenChanged.InvokeAsync(Positionen);
        await OnPositionChanged.InvokeAsync();
    }

    private async Task MovePositionUp(Angebotsposition position)
    {
        var index = Positionen.IndexOf(position);
        if (index > 0)
        {
            Positionen.RemoveAt(index);
            Positionen.Insert(index - 1, position);
            ReorderPositions();
            await PositionenChanged.InvokeAsync(Positionen);
            await OnPositionChanged.InvokeAsync();
        }
    }

    private async Task MovePositionDown(Angebotsposition position)
    {
        var index = Positionen.IndexOf(position);
        if (index < Positionen.Count - 1)
        {
            Positionen.RemoveAt(index);
            Positionen.Insert(index + 1, position);
            ReorderPositions();
            await PositionenChanged.InvokeAsync(Positionen);
            await OnPositionChanged.InvokeAsync();
        }
    }

    private void ReorderPositions()
    {
        for (int i = 0; i < Positionen.Count; i++)
        {
            Positionen[i].Position = i + 1;
        }
    }
}
