@page "/settings/pdf-anpassung"
@using Kuestencode.Core.Interfaces
@using Kuestencode.Core.Models
@using Kuestencode.Shared.UI.Components.Settings
@using Kuestencode.Werkbank.Offerte.Domain.Entities
@inject IOfferteSettingsService SettingsService
@inject CoreInterfaces.ICompanyService CompanyService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>PDF-Anpassung - Küstencode Offerte</PageTitle>

<div style="width: 100%; padding: 24px;">
    <div style="display: flex; gap: 24px; flex-wrap: wrap;">
        <!-- Settings Panel -->
        <div style="flex: 1 1 500px; min-width: 400px;">
            <PdfSettingsEditor
                Settings="@_pdfSettings"
                SettingsChanged="@OnSettingsChanged"
                Context="@DocumentSettingsContext.Angebot"
                Loading="@_loading"
                Saving="@_saving"
                OnSave="@HandleSubmit"
                OnReset="@ResetToDefaults" />
        </div>

        <!-- Live Preview Panel -->
        <div style="flex: 1 1 500px; min-width: 400px;">
            <div style="position: sticky; top: 20px;">
                <MudPaper Elevation="2" Class="pa-6">
                    <MudText Typo="Typo.h6" Class="mb-3">Live-Vorschau</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-4">
                        Beispiel-Angebot mit aktuellen Einstellungen
                    </MudText>

                    @if (!_loading)
                    {
                        <div style="max-height: calc(100vh - 200px); overflow-y: auto;">
                            <OffertePdfPreview Settings="@_offerteSettings" Company="@_company" />
                        </div>
                    }
                </MudPaper>
            </div>
        </div>
    </div>
</div>

@code {
    private Company _company = new();
    private OfferteSettings _offerteSettings = new();
    private PdfSettingsModel _pdfSettings = new();
    private bool _loading = true;
    private bool _saving = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _company = await CompanyService.GetCompanyAsync();
            _offerteSettings = await SettingsService.GetSettingsAsync();
            _pdfSettings = new PdfSettingsModel
            {
                Layout = _offerteSettings.PdfLayout,
                PrimaryColor = _offerteSettings.PdfPrimaryColor,
                AccentColor = _offerteSettings.PdfAccentColor,
                HeaderText = _offerteSettings.PdfHeaderText,
                FooterText = _offerteSettings.PdfFooterText,
                NoticeText = _offerteSettings.PdfValidityNotice
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Laden: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void OnSettingsChanged(PdfSettingsModel settings)
    {
        _pdfSettings = settings;
        _offerteSettings.PdfLayout = settings.Layout;
        _offerteSettings.PdfPrimaryColor = settings.PrimaryColor;
        _offerteSettings.PdfAccentColor = settings.AccentColor;
        _offerteSettings.PdfHeaderText = settings.HeaderText;
        _offerteSettings.PdfFooterText = settings.FooterText;
        _offerteSettings.PdfValidityNotice = settings.NoticeText;
        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        _saving = true;
        try
        {
            await SettingsService.UpdateSettingsAsync(_offerteSettings);
            Snackbar.Add("PDF-Anpassungen gespeichert", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Speichern: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task ResetToDefaults()
    {
        var result = await DialogService.ShowMessageBox(
            "Auf Standard zurücksetzen",
            "Möchten Sie wirklich alle PDF-Anpassungen auf die Standardwerte zurücksetzen?",
            yesText: "Ja, zurücksetzen",
            cancelText: "Abbrechen");

        if (result == true)
        {
            _pdfSettings = new PdfSettingsModel
            {
                Layout = Kuestencode.Core.Enums.PdfLayout.Klar,
                PrimaryColor = "#1f3a5f",
                AccentColor = "#3FA796",
                HeaderText = null,
                FooterText = null,
                NoticeText = null
            };
            OnSettingsChanged(_pdfSettings);
            Snackbar.Add("Auf Standardwerte zurückgesetzt", Severity.Info);
        }
    }
}
