@page "/settings/pdf-anpassung"
@using Kuestencode.Core.Enums
@using Kuestencode.Core.Interfaces
@using Kuestencode.Core.Models
@using Kuestencode.Rapport.Services
@using Kuestencode.Shared.UI.Components
@using Kuestencode.Shared.UI.Components.Settings
@using RapportSettingsModel = Kuestencode.Rapport.Models.RapportSettings
@inject SettingsService SettingsService
@inject ICompanyService CompanyService
@inject TimesheetPreviewService PreviewService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>PDF-Anpassung - Küstencode Rapport</PageTitle>

<div style="width: 100%; padding: 24px;">
    <div style="display: flex; gap: 24px; flex-wrap: wrap;">
        <!-- Settings Panel -->
        <div style="flex: 0 0 45%; max-width: 45%;" class="d-none d-lg-block">
            <PdfSettingsEditor
                Settings="@_pdfSettings"
                SettingsChanged="@OnSettingsChanged"
                Context="@DocumentSettingsContext.Taetigkeit"
                Loading="@_loading"
                Saving="@_saving"
                OnSave="@HandleSubmit"
                OnReset="@ResetToDefaults" />
        </div>

        <!-- Settings Panel - Mobile only -->
        <div style="flex: 0 0 100%; max-width: 100%;" class="d-lg-none">
            <PdfSettingsEditor
                Settings="@_pdfSettings"
                SettingsChanged="@OnSettingsChanged"
                Context="@DocumentSettingsContext.Taetigkeit"
                Loading="@_loading"
                Saving="@_saving"
                OnSave="@HandleSubmit"
                OnReset="@ResetToDefaults" />
        </div>

        <!-- Live Preview Panel - Mobile only -->
        <div style="flex: 0 0 100%; max-width: 100%;" class="d-lg-none">
            <MudPaper Elevation="2" Class="pa-6">
                <MudText Typo="Typo.h6" Class="mb-3">Live-Vorschau</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-4">
                    Beispiel-Tätigkeitsnachweis mit aktuellen Einstellungen
                </MudText>

                @if (!_loading)
                {
                    <div style="max-height: 100vh; overflow-y: auto;">
                        <PdfPreview GeneratePdf="@GeneratePreviewPdf" />
                    </div>
                }
            </MudPaper>
        </div>

        <!-- Live Preview Panel - Desktop only -->
        <div style="flex: 0 0 45%; max-width: 45%;" class="d-none d-lg-block">
            <div style="position: sticky; top: 20px;">
                <MudPaper Elevation="2" Class="pa-6">
                    <MudText Typo="Typo.h6" Class="mb-3">Live-Vorschau</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-4">
                        Beispiel-Tätigkeitsnachweis mit aktuellen Einstellungen
                    </MudText>

                    @if (!_loading)
                    {
                        <div style="max-height: calc(100vh - 200px); overflow-y: auto;">
                            <PdfPreview GeneratePdf="@GeneratePreviewPdf" />
                        </div>
                    }
                </MudPaper>
            </div>
        </div>
    </div>
</div>

@code {
    private RapportSettingsModel _settings = RapportSettingsModel.CreateDefault();
    private Company _company = new();
    private PdfSettingsModel _pdfSettings = new();
    private bool _loading = true;
    private bool _saving = false;

    private byte[]? GeneratePreviewPdf()
    {
        return PreviewService.GeneratePreview(_settings, _company);
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _settings = await SettingsService.GetSettingsAsync();
            _company = await CompanyService.GetCompanyAsync();
            _pdfSettings = new PdfSettingsModel
            {
                Layout = _settings.PdfLayout,
                PrimaryColor = _settings.PdfPrimaryColor,
                AccentColor = _settings.PdfAccentColor,
                HeaderText = _settings.PdfHeaderText,
                FooterText = _settings.PdfFooterText,
                NoticeText = null // Rapport doesn't use this field
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Laden: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void OnSettingsChanged(PdfSettingsModel settings)
    {
        _pdfSettings = settings;
        _settings.PdfLayout = settings.Layout;
        _settings.PdfPrimaryColor = settings.PrimaryColor;
        _settings.PdfAccentColor = settings.AccentColor;
        _settings.PdfHeaderText = settings.HeaderText;
        _settings.PdfFooterText = settings.FooterText;
        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        _saving = true;
        try
        {
            await SettingsService.UpdateSettingsAsync(_settings);
            Snackbar.Add("PDF-Anpassungen gespeichert", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Speichern: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task ResetToDefaults()
    {
        var result = await DialogService.ShowMessageBox(
            "Auf Standard zurücksetzen",
            "Möchten Sie wirklich alle PDF-Anpassungen auf die Standardwerte zurücksetzen?",
            yesText: "Ja, zurücksetzen",
            cancelText: "Abbrechen");

        if (result == true)
        {
            _pdfSettings = new PdfSettingsModel
            {
                Layout = PdfLayout.Klar,
                PrimaryColor = "#1f3a5f",
                AccentColor = "#3FA796",
                HeaderText = null,
                FooterText = null,
                NoticeText = null
            };
            OnSettingsChanged(_pdfSettings);
            Snackbar.Add("Auf Standardwerte zurückgesetzt", Severity.Info);
        }
    }
}
