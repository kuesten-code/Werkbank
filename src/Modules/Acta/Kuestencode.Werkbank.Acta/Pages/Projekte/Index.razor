@page "/projekte"
@using Kuestencode.Werkbank.Acta.Domain.Enums
@using Kuestencode.Werkbank.Acta.Shared.Components
@using Kuestencode.Werkbank.Acta.Shared.Dialogs
@inject Kuestencode.Werkbank.Acta.Services.IProjectService ProjectService
@inject CoreInterfaces.ICustomerService CustomerService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Projekte - Küstencode Acta</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Projekte</MudText>

    <MudPaper Class="pa-4 mt-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudTextField @bind-Value="_searchString" Placeholder="Projekt oder Kunde suchen"
                             Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                             IconSize="Size.Medium" Class="mt-0" Immediate="true" Style="max-width: 300px;" />
                <MudSelect T="int?" Label="Kunde" Value="_selectedCustomerId" ValueChanged="OnCustomerFilterChanged"
                          Clearable="true" Style="min-width: 200px;" Variant="Variant.Outlined" Margin="Margin.Dense">
                    @foreach (var customer in _customers)
                    {
                        <MudSelectItem T="int?" Value="@customer.Id">@customer.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudStack>
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                      StartIcon="@Icons.Material.Filled.Add" OnClick="CreateProject">
                Neues Projekt
            </MudButton>
        </MudStack>

        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" Class="mb-4"
                @bind-ActivePanelIndex="_activeTabIndex" @bind-ActivePanelIndex:after="OnTabChanged">
            <MudTabPanel Text="Alle" Icon="@Icons.Material.Filled.List" />
            <MudTabPanel Text="Entwurf" Icon="@Icons.Material.Filled.Edit" BadgeData="@_draftCount" BadgeColor="Color.Default" />
            <MudTabPanel Text="Aktiv" Icon="@Icons.Material.Filled.PlayArrow" BadgeData="@_activeCount" BadgeColor="Color.Success" />
            <MudTabPanel Text="Pausiert" Icon="@Icons.Material.Filled.Pause" BadgeData="@_pausedCount" BadgeColor="Color.Warning" />
            <MudTabPanel Text="Abgeschlossen" Icon="@Icons.Material.Filled.CheckCircle" BadgeData="@_completedCount" BadgeColor="Color.Info" />
            <MudTabPanel Text="Archiv" Icon="@Icons.Material.Filled.Archive" BadgeData="@_archivedCount" BadgeColor="Color.Dark" />
        </MudTabs>

        <MudTable Items="@_filteredProjects" Hover="true" Breakpoint="Breakpoint.Sm"
                 Loading="@_loading" LoadingProgressColor="Color.Info"
                 RowsPerPage="10" SortLabel="Sortieren nach"
                 OnRowClick="@(args => ViewProject(args.Item!.Id))" T="Project" RowClass="cursor-pointer">
            <HeaderContent>
                <MudTh><MudTableSortLabel SortBy="new Func<Project, object>(x => x.ProjectNumber)">Projektnr.</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<Project, object>(x => x.Name)">Name</MudTableSortLabel></MudTh>
                <MudTh>Kunde</MudTh>
                <MudTh>Status</MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<Project, object>(x => x.TargetDate ?? DateOnly.MaxValue)">Zieldatum</MudTableSortLabel></MudTh>
                <MudTh>Fortschritt</MudTh>
                <MudTh Style="text-align: right">Aktionen</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Projektnr.">@context.ProjectNumber</MudTd>
                <MudTd DataLabel="Name">@context.Name</MudTd>
                <MudTd DataLabel="Kunde">@GetCustomerName(context.CustomerId)</MudTd>
                <MudTd DataLabel="Status">
                    <ProjectStatusBadge Status="@context.Status" />
                </MudTd>
                <MudTd DataLabel="Zieldatum">
                    @if (context.TargetDate.HasValue)
                    {
                        var isOverdue = context.TargetDate.Value < DateOnly.FromDateTime(DateTime.Today)
                                        && context.Status == ProjectStatus.Active;
                        <MudText Color="@(isOverdue ? Color.Error : Color.Default)">
                            @context.TargetDate.Value.ToString("dd.MM.yyyy")
                        </MudText>
                    }
                    else
                    {
                        <MudText Color="Color.Secondary">-</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Fortschritt">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudProgressLinear Color="@GetProgressColor(context.ProgressPercent)"
                                          Value="@context.ProgressPercent"
                                          Style="width: 80px;" />
                        <MudText Typo="Typo.caption">@context.CompletedTasksCount/@context.Tasks.Count</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Aktionen" Style="text-align: right" @onclick:stopPropagation="true">
                    <MudTooltip Text="Anzeigen">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                      Color="Color.Info" Size="Size.Small"
                                      OnClick="@(() => ViewProject(context.Id))" />
                    </MudTooltip>
                    @if (context.IsEditable)
                    {
                        <MudTooltip Text="Bearbeiten">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                          Color="Color.Primary" Size="Size.Small"
                                          OnClick="@(() => EditProject(context.Id))" />
                        </MudTooltip>
                    }
                    @if (context.Status == ProjectStatus.Draft)
                    {
                        <MudTooltip Text="Löschen">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                          Color="Color.Error" Size="Size.Small"
                                          OnClick="@(() => DeleteProject(context))" />
                        </MudTooltip>
                    }
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Typo="Typo.body1" Align="Align.Center" Class="pa-4">
                    @if (_loading)
                    {
                        <text>Lade Projekte...</text>
                    }
                    else
                    {
                        <text>Noch keine Projekte vorhanden.</text>
                    }
                </MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudContainer>

<style>
    .cursor-pointer {
        cursor: pointer;
    }
</style>

@code {
    [SupplyParameterFromQuery(Name = "status")]
    public string? StatusFilter { get; set; }

    private bool _loading = true;
    private string _searchString = string.Empty;
    private int _activeTabIndex = 0;
    private int? _selectedCustomerId;

    private List<Project> _projects = new();
    private List<Kuestencode.Core.Models.Customer> _customers = new();
    private Dictionary<int, string> _customerNames = new();

    private int _draftCount;
    private int _activeCount;
    private int _pausedCount;
    private int _completedCount;
    private int _archivedCount;

    private IEnumerable<Project> _filteredProjects => GetFilteredProjects();

    protected override async Task OnInitializedAsync()
    {
        _activeTabIndex = StatusFilter?.ToLowerInvariant() switch
        {
            "draft" => 1,
            "active" => 2,
            "paused" => 3,
            "completed" => 4,
            "archived" => 5,
            _ => 0
        };

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;

        try
        {
            _projects = await ProjectService.GetAllAsync();

            var customers = await CustomerService.GetAllAsync();
            _customers = customers;
            _customerNames = customers.ToDictionary(c => c.Id, c => c.Name);

            UpdateCounts();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Laden: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void UpdateCounts()
    {
        _draftCount = _projects.Count(p => p.Status == ProjectStatus.Draft);
        _activeCount = _projects.Count(p => p.Status == ProjectStatus.Active);
        _pausedCount = _projects.Count(p => p.Status == ProjectStatus.Paused);
        _completedCount = _projects.Count(p => p.Status == ProjectStatus.Completed);
        _archivedCount = _projects.Count(p => p.Status == ProjectStatus.Archived);
    }

    private IEnumerable<Project> GetFilteredProjects()
    {
        var filtered = _projects.AsEnumerable();

        // Filter by tab
        filtered = _activeTabIndex switch
        {
            1 => filtered.Where(p => p.Status == ProjectStatus.Draft),
            2 => filtered.Where(p => p.Status == ProjectStatus.Active),
            3 => filtered.Where(p => p.Status == ProjectStatus.Paused),
            4 => filtered.Where(p => p.Status == ProjectStatus.Completed),
            5 => filtered.Where(p => p.Status == ProjectStatus.Archived),
            _ => filtered
        };

        // Filter by search
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            var search = _searchString.ToLowerInvariant();
            filtered = filtered.Where(p =>
                p.ProjectNumber.ToLowerInvariant().Contains(search) ||
                p.Name.ToLowerInvariant().Contains(search) ||
                GetCustomerName(p.CustomerId).ToLowerInvariant().Contains(search) ||
                (p.Description?.ToLowerInvariant().Contains(search) ?? false));
        }

        if (_selectedCustomerId.HasValue)
        {
            filtered = filtered.Where(p => p.CustomerId == _selectedCustomerId.Value);
        }

        return filtered.OrderByDescending(p => p.CreatedAt);
    }

    private string GetCustomerName(int customerId)
    {
        return _customerNames.TryGetValue(customerId, out var name) ? name : "Kunde";
    }

    private Color GetProgressColor(int percent) => percent switch
    {
        100 => Color.Success,
        >= 50 => Color.Info,
        > 0 => Color.Warning,
        _ => Color.Default
    };

    private async Task OnTabChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnCustomerFilterChanged(int? customerId)
    {
        _selectedCustomerId = customerId;
        await InvokeAsync(StateHasChanged);
    }

    private void CreateProject()
    {
        NavigationManager.NavigateTo("/acta/projekte/neu");
    }

    private void ViewProject(Guid id)
    {
        NavigationManager.NavigateTo($"/acta/projekte/{id}");
    }

    private void EditProject(Guid id)
    {
        NavigationManager.NavigateTo($"/acta/projekte/{id}/bearbeiten");
    }

    private async Task DeleteProject(Project project)
    {
        var parameters = new DialogParameters<Kuestencode.Werkbank.Acta.Shared.Dialogs.ConfirmDialog>
        {
            { x => x.Title, "Projekt löschen" },
            { x => x.ContentText, $"Möchten Sie das Projekt '{project.Name}' wirklich löschen?" },
            { x => x.ButtonText, "Löschen" },
            { x => x.Color, Color.Error }
        };

        var dialog = await DialogService.ShowAsync<Kuestencode.Werkbank.Acta.Shared.Dialogs.ConfirmDialog>("Löschen", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                await ProjectService.DeleteAsync(project.Id);
                Snackbar.Add($"Projekt '{project.Name}' wurde gelöscht.", Severity.Success);
                await LoadDataAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Fehler beim Löschen: {ex.Message}", Severity.Error);
            }
        }
    }
}
